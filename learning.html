<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GyanNova - Learning Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <script src="https://unpkg.com/splitting@1.0.6/dist/splitting.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/splitting@1.0.6/dist/splitting.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --sage-green: #2D5A3D;
            --terracotta: #C4704A;
            --cream: #F8F6F0;
            --gold: #D4A574;
            --slate-blue: #4A5568;
            --coral: #E8A598;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, #F0EDE6 100%);
            min-height: 100vh;
        }

        .problem-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .problem-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .answer-input {
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
            font-size: 1.1rem;
        }

        .answer-input:focus {
            border-color: var(--sage-green);
            box-shadow: 0 0 0 3px rgba(45, 90, 61, 0.1);
        }

        .answer-input.correct {
            border-color: #10b981;
            background-color: #ecfdf5;
        }

        .answer-input.incorrect {
            border-color: #ef4444;
            background-color: #fef2f2;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--sage-green), #3A6B4A);
            color: white;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(45, 90, 61, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--terracotta), #D4805A);
            color: white;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(196, 112, 74, 0.3);
        }

        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 0.5s ease-in-out;
        }

        .hint-panel {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-left: 4px solid #f59e0b;
            transition: all 0.3s ease;
        }

        .solution-panel {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            border-left: 4px solid #10b981;
            transition: all 0.3s ease;
        }

        .feedback-message {
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
        }

        .feedback-success {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
            border: 1px solid #10b981;
        }

        .feedback-error {
            background: linear-gradient(135deg, #fef2f2, #fecaca);
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .topic-badge {
            background: linear-gradient(135deg, var(--sage-green), #3A6B4A);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .difficulty-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .difficulty-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e5e7eb;
        }

        .difficulty-dot.active {
            background: var(--sage-green);
        }

        .streak-counter {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .timer {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            text-align: center;
            transition: all 0.3s ease;
        }

        .achievement-popup.show {
            transform: translate(-50%, -50%) scale(1);
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #f59e0b;
            animation: confetti-fall 3s linear infinite;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* Screen Reader Only - Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>
</head>

<body>
    <!-- Session Setup Modal -->
    <!-- Onboarding Modal (Multi-step) -->
    <div id="onboardingModal"
        class="fixed inset-0 bg-slate-900 bg-opacity-95 z-[100] flex items-center justify-center p-4 backdrop-blur-md transition-all duration-500">

        <!-- Step 1: User Profile Selection -->
        <div id="onboardingStep1"
            class="bg-white rounded-3xl max-w-4xl w-full p-10 shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500">
            </div>

            <div class="text-center mb-12">
                <h1 class="text-4xl font-black text-gray-800 mb-4 tracking-tight">Who is learning today?</h1>
                <p class="text-lg text-gray-500">Select your profile to personalize the AI experience.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-3xl mx-auto">
                <!-- Rahul Profile -->
                <button onclick="selectProfile('strong')"
                    class="group relative bg-indigo-50 hover:bg-indigo-600 border-2 border-indigo-100 hover:border-indigo-600 rounded-2xl p-8 transition-all duration-300 transform hover:-translate-y-2 hover:shadow-xl text-left">
                    <div
                        class="absolute top-4 right-4 text-3xl opacity-50 group-hover:opacity-100 group-hover:scale-110 transition-all">
                        üöÄ</div>
                    <div
                        class="w-20 h-20 bg-white rounded-full flex items-center justify-center text-4xl mb-6 shadow-md border-4 border-indigo-100 group-hover:border-white/20 transition-all">
                        üë®‚Äçüéì
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 group-hover:text-white mb-2">Rahul</h3>
                    <div class="flex items-center gap-2 mb-4">
                        <span
                            class="px-3 py-1 bg-indigo-200 text-indigo-800 text-xs font-bold rounded-full group-hover:bg-white/20 group-hover:text-white">Advanced</span>
                        <span
                            class="px-3 py-1 bg-green-200 text-green-800 text-xs font-bold rounded-full group-hover:bg-white/20 group-hover:text-white">Fast
                            Paced</span>
                    </div>
                    <p class="text-gray-600 group-hover:text-indigo-100 text-sm leading-relaxed">
                        Ready for challenging problems and deep conceptual dives. The AI checks work strictly.
                    </p>
                </button>

                <!-- Ram Profile -->
                <button onclick="selectProfile('weak')"
                    class="group relative bg-orange-50 hover:bg-orange-500 border-2 border-orange-100 hover:border-orange-500 rounded-2xl p-8 transition-all duration-300 transform hover:-translate-y-2 hover:shadow-xl text-left">
                    <div
                        class="absolute top-4 right-4 text-3xl opacity-50 group-hover:opacity-100 group-hover:scale-110 transition-all">
                        üå±</div>
                    <div
                        class="w-20 h-20 bg-white rounded-full flex items-center justify-center text-4xl mb-6 shadow-md border-4 border-orange-100 group-hover:border-white/20 transition-all">
                        üßë‚Äçüíª
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 group-hover:text-white mb-2">Ram</h3>
                    <div class="flex items-center gap-2 mb-4">
                        <span
                            class="px-3 py-1 bg-orange-200 text-orange-800 text-xs font-bold rounded-full group-hover:bg-white/20 group-hover:text-white">Foundational</span>
                        <span
                            class="px-3 py-1 bg-blue-200 text-blue-800 text-xs font-bold rounded-full group-hover:bg-white/20 group-hover:text-white">Guided</span>
                    </div>
                    <p class="text-gray-600 group-hover:text-orange-100 text-sm leading-relaxed">
                        Needs step-by-step guidance and simpler explanations. The AI is encouraging and patient.
                    </p>
                </button>
            </div>
        </div>

        <!-- Step 2: Subject Selection (Hidden initially) -->
        <div id="onboardingStep2" class="hidden bg-white rounded-3xl max-w-2xl w-full p-10 shadow-2xl relative">
            <button onclick="backToStep1()"
                class="absolute top-6 left-6 text-gray-400 hover:text-gray-800 transition-colors flex items-center gap-2 font-medium">
                ‚Üê Back
            </button>

            <div class="text-center mb-10 mt-4">
                <div
                    class="w-16 h-16 bg-gradient-to-br from-green-400 to-emerald-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg rotate-3">
                    <span class="text-3xl text-white">üìö</span>
                </div>
                <h2 class="text-3xl font-bold text-gray-800">What are we mastering?</h2>
                <p class="text-gray-500 mt-2">Select a topic to generate your first AI challenge.</p>
            </div>

            <div class="space-y-6">
                <!-- Class Selection -->
                <div class="relative group">
                    <label class="block text-xs font-bold text-gray-400 mb-2 uppercase tracking-wide ml-1">Class</label>
                    <select id="classSelectorOnboarding" onchange="onClassChange()"
                        class="w-full px-6 py-4 bg-gray-50 border-2 border-gray-100 rounded-xl focus:ring-4 focus:ring-purple-100 focus:border-purple-500 outline-none appearance-none font-bold text-lg text-gray-700 transition-all cursor-pointer hover:bg-white">
                        <option value="">Choose a class...</option>
                        <!-- Options injected via JS -->
                    </select>
                    <div
                        class="absolute inset-y-0 right-0 flex items-center px-6 pointer-events-none text-gray-400 group-hover:text-purple-600 transition-colors pt-6">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </div>
                </div>

                <!-- Subject Selection -->
                <div id="subjectContainer" class="relative group opacity-50 pointer-events-none transition-all">
                    <label
                        class="block text-xs font-bold text-gray-400 mb-2 uppercase tracking-wide ml-1">Subject</label>
                    <select id="subjectSelectorOnboarding" onchange="onSubjectChange()"
                        class="w-full px-6 py-4 bg-gray-50 border-2 border-gray-100 rounded-xl focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none appearance-none font-bold text-lg text-gray-700 transition-all cursor-pointer hover:bg-white">
                        <option value="">Choose a subject...</option>
                        <!-- Options injected via JS -->
                    </select>
                    <div
                        class="absolute inset-y-0 right-0 flex items-center px-6 pointer-events-none text-gray-400 group-hover:text-blue-600 transition-colors pt-6">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </div>
                </div>

                <!-- Topic Selection -->
                <div id="topicContainer" class="relative group opacity-50 pointer-events-none transition-all">
                    <label class="block text-xs font-bold text-gray-400 mb-2 uppercase tracking-wide ml-1">Topic</label>
                    <select id="topicSelectorOnboarding" onchange="checkTopicReady()" disabled
                        class="w-full px-6 py-4 bg-gray-50 border-2 border-gray-100 rounded-xl focus:ring-4 focus:ring-green-100 focus:border-green-500 outline-none appearance-none font-bold text-lg text-gray-700 transition-all cursor-pointer hover:bg-white">
                        <option value="">Select a subject first...</option>
                        <!-- Options injected via JS -->
                    </select>
                    <div
                        class="absolute inset-y-0 right-0 flex items-center px-6 pointer-events-none text-gray-400 group-hover:text-green-600 transition-colors pt-6">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </div>
                </div>

                <div class="text-xs text-gray-400 text-center">
                    The AI will generate a unique question based on this topic.
                </div>

                <button id="startSessionBtn" disabled onclick="completeOnboarding()"
                    class="w-full py-4 bg-gray-200 text-gray-400 font-bold rounded-xl text-lg transition-all transform scale-100 flex items-center justify-center gap-3">
                    <span>Ask AI for Question</span>
                    <span class="text-xl">‚ú®</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts for Onboarding -->
    <script>
        // Onboarding Logic
        window.selectedProfile = null;

        function selectProfile(profile) {
            window.selectedProfile = profile;

            // Safety check: Ensure session is initialized
            if (window.learningSession) {
                window.learningSession.switchStudentProfile(profile);
            } else {
                console.warn("LearningSession not yet ready, queuing profile selection.");
                // Retrying slightly later or setting it when init happens
                setTimeout(() => { if (window.learningSession) window.learningSession.switchStudentProfile(profile); }, 500);
            }

            // Trigger populating classes (which triggers subjects eventually)
            if (window.populateOnboardingClasses) window.populateOnboardingClasses();

            // Update the navbar profile badge
            updateProfileBadge(profile);

            // Animate transition
            document.getElementById('onboardingStep1').classList.add('hidden');
            document.getElementById('onboardingStep2').classList.remove('hidden');
            document.getElementById('onboardingStep2').classList.add('animate-slide-up');
        }

        // Update Profile Badge in Navbar
        function updateProfileBadge(profile) {
            const badge = document.getElementById('studentProfileBadge');
            const avatar = document.getElementById('studentAvatar');
            const nameDisplay = document.getElementById('studentNameDisplay');

            if (profile === 'strong') {
                // Rahul - Strong Student
                badge.className = 'flex items-center gap-3 px-5 py-2.5 rounded-full border-2 border-indigo-300 bg-indigo-50 transition-all duration-300 shadow-sm hover:shadow-md';
                avatar.className = 'w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center text-lg';
                avatar.textContent = 'üéì';
                nameDisplay.textContent = 'Rahul';
                nameDisplay.className = 'text-sm font-bold text-indigo-700';
            } else if (profile === 'weak') {
                // Ram - Foundational Student
                badge.className = 'flex items-center gap-3 px-5 py-2.5 rounded-full border-2 border-orange-300 bg-orange-50 transition-all duration-300 shadow-sm hover:shadow-md';
                avatar.className = 'w-8 h-8 rounded-full bg-orange-500 flex items-center justify-center text-lg';
                avatar.textContent = 'üå±';
                nameDisplay.textContent = 'Ram';
                nameDisplay.className = 'text-sm font-bold text-orange-700';
            } else {
                // Default/No selection
                badge.className = 'flex items-center gap-3 px-5 py-2.5 rounded-full border-2 border-gray-300 bg-gray-50 transition-all duration-300 shadow-sm hover:shadow-md';
                avatar.className = 'w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-lg';
                avatar.textContent = 'üë§';
                nameDisplay.textContent = 'Select Profile';
                nameDisplay.className = 'text-sm font-bold text-gray-600';
            }
        }

        // Show Profile Switcher (reopen onboarding modal)
        function showProfileSwitcher() {
            document.getElementById('onboardingModal').classList.remove('hidden');
            document.getElementById('onboardingStep1').classList.remove('hidden');
            document.getElementById('onboardingStep2').classList.add('hidden');
        }

        function backToStep1() {
            document.getElementById('onboardingStep2').classList.add('hidden');
            document.getElementById('onboardingStep1').classList.remove('hidden');
        }

        function checkTopicReady() {
            const selector = document.getElementById('topicSelectorOnboarding');
            const btn = document.getElementById('startSessionBtn');
            if (selector.value) {
                btn.disabled = false;
                btn.classList.remove('bg-gray-200', 'text-gray-400');
                btn.classList.add('bg-sage-green', 'text-white', 'shadow-lg', 'hover:scale-105');
            } else {
                btn.disabled = true;
                btn.classList.add('bg-gray-200', 'text-gray-400');
                btn.classList.remove('bg-sage-green', 'text-white', 'shadow-lg', 'hover:scale-105');
            }
        }

        function completeOnboarding() {
            const topic = document.getElementById('topicSelectorOnboarding').value;
            if (!topic) return;

            // Get student name from profile
            const studentName = window.selectedProfile === 'strong' ? 'Rahul' : 'Ram';

            // Set topic in main session
            document.getElementById('topicBadge').textContent = topic;

            // Show welcome message with student name
            const welcomeDiv = document.getElementById('assessmentWelcome');
            const welcomeNameSpan = document.getElementById('welcomeStudentName');
            welcomeNameSpan.textContent = studentName;
            welcomeDiv.classList.remove('hidden');

            // Hide profile badge during assessment
            document.getElementById('studentProfileBadge').style.display = 'none';

            // Announce to screen reader
            announceToScreenReader(`Welcome ${studentName}! Starting your assessment on ${topic}. Good luck!`);

            // Auto-hide welcome message after 4 seconds
            setTimeout(() => {
                welcomeDiv.classList.add('hidden');
            }, 4000);

            // Close modal
            document.getElementById('onboardingModal').classList.add('hidden');

            // Trigger AI Generation immediately
            setTimeout(() => {
                switchMode('quiz');
                window.generateAIQuestion();
            }, 300);
        }

        // Populate Classes on Load or Profile Select
        function populateOnboardingClasses() {
            const selector = document.getElementById('classSelectorOnboarding');
            if (!selector || selector.options.length > 1) return;

            selector.innerHTML = '<option value="">Choose a class...</option>';
            // Hardcoded classes for now as per DB structure (class_9, class_10 usually)
            const classes = ['9', '10', '11', '12'];

            classes.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = `Class ${c}`;
                selector.appendChild(opt);
            });
        }

        function onClassChange() {
            const cls = document.getElementById('classSelectorOnboarding').value;
            const subjectContainer = document.getElementById('subjectContainer');
            const subjectSelector = document.getElementById('subjectSelectorOnboarding');
            const topicContainer = document.getElementById('topicContainer');
            const topicSelector = document.getElementById('topicSelectorOnboarding');

            // Reset downstream
            topicContainer.classList.add('opacity-50', 'pointer-events-none');
            topicSelector.disabled = true;
            topicSelector.innerHTML = '<option value="">Select a subject first...</option>';

            if (!cls) {
                subjectContainer.classList.add('opacity-50', 'pointer-events-none');
                subjectSelector.disabled = true;
                subjectSelector.innerHTML = '<option value="">Select a class first...</option>';
                return;
            }

            // Enable Subject Selector
            subjectContainer.classList.remove('opacity-50', 'pointer-events-none');
            subjectSelector.disabled = false;
            populateOnboardingSubjects();
        }

        // Populate Subjects
        function populateOnboardingSubjects() {
            const selector = document.getElementById('subjectSelectorOnboarding');
            selector.innerHTML = '<option value="">Choose a subject...</option>';

            const subjects = window.CONTENT_DATABASE ? Object.keys(window.CONTENT_DATABASE) : ['mathematics', 'science', 'english', 'history'];

            subjects.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.textContent = s.charAt(0).toUpperCase() + s.slice(1).replace('_', ' ');
                selector.appendChild(opt);
            });
        }

        function onSubjectChange() {
            const subject = document.getElementById('subjectSelectorOnboarding').value;
            // Get Class from the selector, not the student session yet (as we might update it)
            const studentClass = document.getElementById('classSelectorOnboarding').value || '9';

            const topicContainer = document.getElementById('topicContainer');
            const topicSelector = document.getElementById('topicSelectorOnboarding');

            if (!subject) {
                topicContainer.classList.add('opacity-50', 'pointer-events-none');
                topicSelector.disabled = true;
                topicSelector.innerHTML = '<option value="">Select a subject first...</option>';
                return;
            }

            // Enable Topic Selector
            topicContainer.classList.remove('opacity-50', 'pointer-events-none');
            topicSelector.disabled = false;
            topicSelector.innerHTML = '<option value="">Loading topics...</option>';

            // Fetch topics for the selected subject & class
            let topics = [];
            const classKey = `class_${studentClass}`;

            if (window.CONTENT_DATABASE && window.CONTENT_DATABASE[subject] && window.CONTENT_DATABASE[subject][classKey]) {
                topics = window.CONTENT_DATABASE[subject][classKey].topics || [];
            } else {
                // Fallback mock topics
                topics = ['General Concepts', 'Advanced Theory', 'Practical Applications'];
            }

            populateOnboardingTopics(topics);
        }

        function populateOnboardingTopics(topics) {
            const selector = document.getElementById('topicSelectorOnboarding');
            selector.innerHTML = '<option value="">Choose a topic...</option>';
            topics.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t;
                opt.textContent = t;
                selector.appendChild(opt);
            });
        }
    </script>

    <!-- OLD_SETUP_START -->
    <div id="sessionSetupModal-OLD-REMOVED" style="display:none;"
        class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl max-w-lg w-full p-8 shadow-2xl transform transition-all scale-100">
            <div class="text-center mb-8">
                <div
                    class="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <span class="text-3xl">üöÄ</span>
                </div>
                <h3 class="text-2xl font-bold text-gray-800">Start Your Session</h3>
                <p class="text-gray-600 mt-2">What would you like to focus on today?</p>
            </div>

            <div class="space-y-6">
                <!-- Topic Selection -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Select
                        Topic</label>
                    <div class="relative">
                        <select id="topicSelector"
                            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none appearance-none font-medium text-gray-700 transition-all hover:bg-white">
                            <option value="">Loading topics...</option>
                        </select>
                        <div
                            class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-gray-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="grid grid-cols-1 gap-3">
                    <button onclick="startSessionAction('quiz')"
                        class="group relative flex items-center justify-center gap-3 w-full bg-white border-2 border-indigo-100 p-4 rounded-xl hover:border-indigo-500 hover:shadow-md transition-all">
                        <span
                            class="text-2xl bg-indigo-100 p-2 rounded-lg group-hover:bg-indigo-600 group-hover:text-white transition-colors">üìù</span>
                        <div class="text-left flex-1">
                            <h4 class="font-bold text-gray-800 group-hover:text-indigo-700">Take a Quiz</h4>
                            <p class="text-xs text-gray-500">Practice questions & essays</p>
                        </div>
                        <span class="text-gray-300 group-hover:text-indigo-500">‚Üí</span>
                    </button>

                    <button onclick="startSessionAction('notes')"
                        class="group relative flex items-center justify-center gap-3 w-full bg-white border-2 border-green-100 p-4 rounded-xl hover:border-green-500 hover:shadow-md transition-all">
                        <span
                            class="text-2xl bg-green-100 p-2 rounded-lg group-hover:bg-green-600 group-hover:text-white transition-colors">üìñ</span>
                        <div class="text-left flex-1">
                            <h4 class="font-bold text-gray-800 group-hover:text-green-700">Read Concept Note</h4>
                            <p class="text-xs text-gray-500">Revise summaries & key points</p>
                        </div>
                        <span class="text-gray-300 group-hover:text-green-500">‚Üí</span>
                    </button>

                    <button onclick="startSessionAction('doubt')"
                        class="group relative flex items-center justify-center gap-3 w-full bg-white border-2 border-orange-100 p-4 rounded-xl hover:border-orange-500 hover:shadow-md transition-all">
                        <span
                            class="text-2xl bg-orange-100 p-2 rounded-lg group-hover:bg-orange-600 group-hover:text-white transition-colors">ü§î</span>
                        <div class="text-left flex-1">
                            <h4 class="font-bold text-gray-800 group-hover:text-orange-700">Ask a Doubt</h4>
                            <p class="text-xs text-gray-500">Get instant help from Edu AI</p>
                        </div>
                        <span class="text-gray-300 group-hover:text-orange-500">‚Üí</span>
                    </button>
                </div>
            </div>

            <button onclick="document.getElementById('sessionSetupModal').classList.add('hidden')"
                class="mt-6 w-full text-center text-gray-400 hover:text-gray-600 text-sm">Dismiss</button>
        </div>
    </div>
    <!-- Navigation -->
    <nav class="bg-white/90 backdrop-blur-md shadow-sm sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-3">
                <!-- Logo Section -->
                <div class="flex items-center space-x-2">
                    <img src="resources/logo.png" alt="GyanNova Logo" class="w-10 h-10">
                    <span class="text-xl font-bold" style="color: var(--sage-green);">GyanNova</span>
                </div>

                <!-- Center: Student Profile Badge -->
                <div id="studentProfileBadge"
                    class="flex items-center gap-3 px-5 py-2.5 rounded-full border-2 transition-all duration-300 shadow-sm hover:shadow-md">
                    <div class="flex items-center gap-2">
                        <div id="studentAvatar" class="w-8 h-8 rounded-full flex items-center justify-center text-lg">
                            üë§
                        </div>
                        <div class="flex flex-col">
                            <span class="text-xs text-gray-500 font-medium">Learning as</span>
                            <span id="studentNameDisplay" class="text-sm font-bold">Select Profile</span>
                        </div>
                    </div>
                    <button onclick="showProfileSwitcher()" class="text-gray-400 hover:text-gray-600 transition-colors"
                        title="Change Profile">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7h12M8 12h12m-12 5h12M4 7h.01M4 12h.01M4 17h.01"></path>
                        </svg>
                    </button>
                </div>

                <!-- Right: Timers and Actions -->
                <div class="flex items-center space-x-4">
                    <div class="timer bg-blue-100 text-blue-800 border border-blue-200" id="currentQuestionTimer">Curr:
                        0s</div>
                    <div class="timer bg-purple-100 text-purple-800 border border-purple-200" id="avgTimer">Avg: 0s
                    </div>
                    <div class="timer" id="sessionTimer">Total: 00:00</div>
                    <button onclick="toggleDarkMode()"
                        class="text-gray-600 hover:text-gray-800 p-2 rounded-full hover:bg-gray-100 dark:text-gray-300 dark:hover:text-white dark:hover:bg-gray-700 transition-colors"
                        title="Toggle Dark Mode">
                        <span id="darkModeIcon">üåô</span>
                    </button>
                    <button onclick="pauseSession()" class="text-gray-600 hover:text-gray-800 p-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6">
                            </path>
                        </svg>
                    </button>
                    <button onclick="endSession()" class="text-gray-600 hover:text-red-600 p-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Learning Interface -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Mode Switcher -->
        <div class="flex flex-col sm:flex-row justify-center gap-4 mb-8">
            <button onclick="switchMode('quiz')" id="btn-mode-quiz"
                class="mode-btn active flex items-center justify-center gap-2 px-8 py-4 rounded-xl font-bold transition-all shadow-md bg-white border-2 border-indigo-500 text-indigo-700 transform scale-105">
                <span>üìù</span> Quiz Zone
            </button>
            <button onclick="switchMode('notes')" id="btn-mode-notes"
                class="mode-btn flex items-center justify-center gap-2 px-8 py-4 rounded-xl font-bold transition-all shadow-sm bg-white border border-gray-200 text-gray-500 hover:bg-green-50 hover:text-green-600 hover:border-green-200">
                <span>üìñ</span> Concept Notes
            </button>
            <button onclick="switchMode('doubt')" id="btn-mode-doubt"
                class="mode-btn flex items-center justify-center gap-2 px-8 py-4 rounded-xl font-bold transition-all shadow-sm bg-white border border-gray-200 text-gray-500 hover:bg-orange-50 hover:text-orange-600 hover:border-orange-200">
                <span>ü§î</span> Ask EduAI
            </button>
        </div>

        <div class="grid lg:grid-cols-4 gap-8">
            <!-- Progress Sidebar -->
            <div class="lg:col-span-1 lg:order-last" id="sidebarContainer">
                <div class="bg-white rounded-2xl p-6 shadow-lg sticky top-24">
                    <h3 class="text-lg font-bold mb-6 text-gray-800">Your Progress</h3>

                    <!-- Progress Ring -->
                    <div class="flex justify-center mb-6">
                        <div class="relative">
                            <svg class="progress-ring w-24 h-24">
                                <circle cx="48" cy="48" r="40" stroke="#e5e7eb" stroke-width="8" fill="transparent" />
                                <circle id="progressCircle" cx="48" cy="48" r="40" stroke="var(--sage-green)"
                                    stroke-width="8" fill="transparent" stroke-dasharray="251.2"
                                    stroke-dashoffset="251.2" class="progress-ring-circle" />
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span id="progressPercent" class="text-2xl font-bold"
                                    style="color: var(--sage-green);">0%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Student Simulation Switcher (Collapsible) -->
                    <details class="mb-6 group">
                        <summary
                            class="list-none flex justify-between items-center cursor-pointer p-4 bg-indigo-50 rounded-xl border border-indigo-100 hover:bg-indigo-100 transition-colors">
                            <h3 class="font-bold text-gray-700 text-sm flex items-center gap-2">
                                <span>üë•</span> Simulate Profile
                            </h3>
                            <span class="transform group-open:rotate-180 transition-transform text-indigo-400">‚ñº</span>
                        </summary>
                        <div class="p-4 bg-white border border-t-0 border-indigo-100 rounded-b-xl -mt-2 pt-6">
                            <p class="text-xs text-gray-500 mb-3">Test how the AI adapts to different student levels:
                            </p>
                            <div class="flex space-x-2">
                                <button
                                    onclick="window.learningSession.switchStudentProfile('strong'); updateProfileBadge('strong');"
                                    id="btn-strong"
                                    class="flex-1 py-2 text-[10px] font-bold rounded-lg border transition-colors bg-white text-gray-600 border-gray-300 hover:bg-gray-100 shadow-sm">
                                    Rahul (Strong)
                                </button>
                                <button
                                    onclick="window.learningSession.switchStudentProfile('weak'); updateProfileBadge('weak');"
                                    id="btn-weak"
                                    class="flex-1 py-2 text-[10px] font-bold rounded-lg border transition-colors bg-white text-gray-600 border-gray-300 hover:bg-gray-100 shadow-sm">
                                    Ram (Weak)
                                </button>
                            </div>
                        </div>
                    </details>

                    <!-- Stats -->
                    <div class="space-y-4">
                        <div
                            class="flex items-center justify-between bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">‚ö°</span>
                                <span class="font-bold text-yellow-800">XP Earned</span>
                            </div>
                            <span id="xpPoints" class="text-xl font-black text-yellow-600">0</span>
                        </div>

                        <h3 class="font-bold text-gray-700">Your Progress</h3>

                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Problem Set Progress</span>
                                <span id="progressText">0/5</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="progressFill" class="bg-sage-green h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- NEW: Adaptive Mastery Dashboard (Inspired by Cognito) -->
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 mt-6">
                    <h3 class="font-bold text-gray-700 mb-3 flex items-center">
                        <span>üß† Mastery Level</span>
                        <span class="text-xs ml-2 bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">Adaptive</span>
                    </h3>
                    <div id="mastery-container" class="space-y-3">
                        <!-- Dynamic mastery bars will be injected here -->
                        <p class="text-xs text-center text-gray-500 italic">Complete questions to unlock mastery
                            data.</p>
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Problems Solved</span>
                    <span id="problemsSolved" class="font-bold">0</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Accuracy</span>
                    <span id="accuracyPercent" class="font-bold">0%</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600">Current Streak</span>
                    <div class="streak-counter">
                        <span>üî•</span>
                        <span id="streakCount">0</span>
                    </div>
                </div>
            </div>

            <!-- Topic Mastery -->
            <div class="mt-8">
                <h4 class="text-md font-semibold mb-4 text-gray-800">Topic Mastery</h4>
                <div class="space-y-3" id="topicMastery">
                    <!-- Dynamic content will be inserted here -->
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="mt-8 space-y-3">
                <button onclick="showHint()" class="w-full btn-secondary py-2 px-4 rounded-lg font-medium">
                    üí° Get Hint
                </button>
                <button onclick="showNotes()"
                    class="w-full bg-indigo-50 text-indigo-700 py-2 px-4 rounded-lg font-medium hover:bg-indigo-100 transition-colors">
                    üìñ Concept Note
                </button>
                <button onclick="skipProblem()"
                    class="w-full border-2 border-gray-300 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-50 transition-colors">
                    ‚è≠Ô∏è Skip Problem
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="lg:col-span-3 transition-all" id="mainContentArea">

        <!-- QUIZ MODE CONTAINER -->
        <div id="quizContainer" class="mode-container">
            <!-- Welcome Message (shown at start of assessment) -->
            <div id="assessmentWelcome"
                class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl p-6 mb-6 text-white shadow-xl hidden"
                role="alert" aria-live="polite">
                <div class="flex items-center gap-4">
                    <div class="text-5xl">üëã</div>
                    <div>
                        <h2 class="text-2xl font-bold mb-1">Welcome, <span id="welcomeStudentName">Student</span>!</h2>
                        <p class="text-indigo-100">Ready to start your learning journey? Let's begin!</p>
                    </div>
                </div>
            </div>

            <!-- Screen Reader Announcements -->
            <div id="srAnnouncements" class="sr-only" role="status" aria-live="polite" aria-atomic="true"></div>

            <!-- Problem Card -->
            <div class="problem-card rounded-2xl p-8 mb-6 bg-white shadow-xl relative overflow-hidden">

                <!-- Problem Header -->
                <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
                    <div class="flex items-center space-x-4">
                        <div class="topic-badge" id="topicBadge">General</div>
                        <div class="difficulty-indicator" id="difficultyIndicator" role="img"
                            aria-label="Difficulty level">
                            <div class="difficulty-dot active"></div>
                            <div class="difficulty-dot"></div>
                            <div class="difficulty-dot"></div>
                        </div>
                    </div>
                    <div class="text-sm text-gray-500 font-mono" aria-label="Question progress">
                        Q <span id="problemNumber">1</span> / 5
                    </div>
                </div>

                <!-- Problem Question -->
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 leading-relaxed" id="problemQuestion">
                        Loading question...
                    </h2>
                    <div id="problemImage" class="mb-6 hidden">
                        <img src="" alt="Problem diagram" class="max-w-full h-auto rounded-lg shadow-sm">
                    </div>
                </div>

                <!-- Answer Input -->
                <div class="mb-6">
                    <label for="answerInput" class="block text-sm font-semibold text-gray-700 mb-2">Your Answer</label>
                    <div class="flex gap-3 items-start" id="answerContainer">
                        <input type="text" id="answerInput"
                            class="answer-input flex-1 px-6 py-4 rounded-xl bg-gray-50 focus:outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500 transition-all text-lg"
                            placeholder="Type your answer here..." autocomplete="off" aria-label="Answer input field"
                            aria-describedby="answerHelp">

                        <!-- Voice Input Button -->
                        <button id="voiceBtn"
                            class="px-4 py-4 rounded-xl bg-indigo-100 hover:bg-indigo-200 text-indigo-700 font-semibold transition-all shadow-sm hover:shadow-md flex items-center gap-2"
                            aria-label="Activate voice input" title="Click to speak your answer">
                            <span class="text-2xl">üé§</span>
                            <span class="text-sm hidden sm:inline">Voice</span>
                        </button>

                        <!-- Screen Reader Toggle -->
                        <button id="screenReaderBtn"
                            class="px-4 py-4 rounded-xl bg-green-100 hover:bg-green-200 text-green-700 font-semibold transition-all shadow-sm hover:shadow-md flex items-center gap-2"
                            aria-label="Toggle screen reader" title="Enable/Disable screen reader">
                            <span class="text-2xl">üîä</span>
                            <span class="text-sm hidden sm:inline">Read</span>
                        </button>
                    </div>
                    <div id="answerHelp" class="text-xs text-gray-500 mt-2">
                        üí° You can type your answer or use the microphone button to speak. Screen reader available for
                        accessibility.
                    </div>

                    <textarea id="essayInput"
                        class="answer-input w-full px-6 py-4 rounded-xl bg-gray-50 focus:outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500 transition-all text-lg hidden"
                        rows="6" placeholder="Write your detailed answer here..."
                        aria-label="Essay answer input"></textarea>

                    <div id="essayFeedback"
                        class="hidden mt-3 p-4 rounded-lg bg-gray-50 border border-gray-200 text-sm"></div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col gap-3">
                    <div class="flex gap-4">
                        <button onclick="checkAnswer()"
                            class="btn-primary px-8 py-3 rounded-xl font-bold flex-1 shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1">
                            Check Answer
                        </button>
                        <button onclick="showSolution()"
                            class="border-2 border-gray-200 text-gray-600 px-6 py-3 rounded-xl font-bold hover:bg-gray-50 hover:border-gray-300 transition-colors">
                            Solution
                        </button>
                    </div>
                    <button onclick="window.generateAIQuestion()"
                        class="w-full bg-gradient-to-r from-violet-600 to-indigo-600 text-white px-6 py-3 rounded-xl font-bold shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-2 mt-2 hover:-translate-y-1">
                        <span>‚ú®</span> Generate New Question with Edu AI
                    </button>
                </div>

                <!-- Feedback Message -->
                <div id="feedbackMessage" class="feedback-message hidden mt-4" aria-live="polite"></div>
            </div>

            <!-- Hint Panel -->
            <div id="hintPanel" class="hint-panel rounded-2xl p-6 mb-6 hidden shadow-md">
                <div class="flex items-start space-x-3">
                    <div
                        class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center flex-shrink-0 text-white font-bold">
                        üí°</div>
                    <div>
                        <h4 class="font-bold text-yellow-800 mb-2">Hint</h4>
                        <p id="hintText" class="text-yellow-900 leading-relaxed"></p>
                    </div>
                </div>
            </div>

            <!-- Solution Panel -->
            <div id="solutionPanel" class="solution-panel rounded-2xl p-6 mb-6 hidden shadow-md">
                <div class="flex items-start space-x-3">
                    <div
                        class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0 text-white font-bold">
                        ‚úì</div>
                    <div>
                        <h4 class="font-bold text-green-800 mb-2">Solution</h4>
                        <div id="solutionSteps" class="space-y-2 text-green-900 leading-relaxed"></div>
                    </div>
                </div>
            </div>

            <!-- Next Problem Button -->
            <div class="text-center pb-12">
                <button onclick="nextProblem()" id="nextButton"
                    class="btn-primary px-10 py-4 rounded-full font-bold shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all hidden">
                    Next Problem ‚Üí
                </button>
            </div>
        </div>

        <!-- NOTES MODE CONTAINER -->
        <div id="notesContainer" class="mode-container hidden">
            <div class="bg-indigo-50 border-2 border-indigo-100 rounded-2xl p-8 shadow-lg min-h-[500px]">
                <div class="flex items-center gap-4 mb-8 border-b border-indigo-200 pb-4">
                    <span class="text-4xl bg-white p-3 rounded-full shadow-sm">üìñ</span>
                    <div>
                        <h2 class="text-2xl font-bold text-indigo-900">Topic Notes</h2>
                        <p class="text-indigo-600">Summary & Key Concepts</p>
                    </div>
                </div>
                <div class="prose prose-indigo max-w-none">
                    <p id="noteText" class="text-lg text-indigo-900 leading-8 whitespace-pre-line">
                        Select a topic to view its notes.
                    </p>
                </div>
            </div>
        </div>

        <!-- DOUBT MODE CONTAINER -->
        <div id="doubtContainer" class="mode-container hidden">
            <div
                class="bg-gradient-to-br from-orange-50 to-amber-50 border-2 border-orange-100 rounded-2xl p-8 shadow-lg min-h-[500px]">
                <div class="flex items-center gap-4 mb-8">
                    <span class="text-4xl bg-white p-3 rounded-full shadow-sm">ü§ñ</span>
                    <div>
                        <h2 class="text-2xl font-bold text-orange-900">Edu AI Tutor</h2>
                        <p class="text-orange-700">Ask any doubt and get instant help</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border border-orange-100 mb-6">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Your Question</label>
                    <div class="flex gap-2">
                        <input type="text" id="doubtInput"
                            class="flex-1 px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all"
                            placeholder="e.g. Why is the sky blue?">
                        <button onclick="window.solveDoubt()"
                            class="bg-orange-500 text-white px-8 py-3 rounded-xl font-bold hover:bg-orange-600 transition-colors shadow-md">
                            Ask
                        </button>
                    </div>
                </div>

                <div id="doubtAnswer"
                    class="hidden p-6 bg-white rounded-xl border border-orange-200 text-gray-800 text-lg leading-relaxed shadow-sm">
                </div>
            </div>
        </div>

    </div>
    </div>
    </div>


    <!-- Achievement Popup -->
    <div id="achievementPopup" class="achievement-popup">
        <div class="text-center">
            <div
                class="w-16 h-16 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="text-white text-2xl">üèÜ</span>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Achievement Unlocked!</h3>
            <p id="achievementText" class="text-gray-600 mb-4">You've solved 5 problems in a row!</p>
            <button onclick="closeAchievement()" class="btn-primary px-6 py-2 rounded-lg font-semibold">
                Continue Learning
            </button>
        </div>
    </div>

    <!-- Pause Modal -->
    <div id="pauseModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full p-8 text-center">
            <div
                class="w-16 h-16 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-6">
                <span class="text-white text-2xl">‚è∏Ô∏è</span>
            </div>
            <h3 class="text-2xl font-bold mb-4 text-gray-800">Session Paused</h3>
            <p class="text-gray-600 mb-6">Take a break! Your progress has been saved.</p>
            <div class="flex gap-4">
                <button onclick="resumeSession()" class="flex-1 btn-primary px-6 py-3 rounded-lg font-semibold">
                    Resume Learning
                </button>
                <button onclick="endSession()"
                    class="flex-1 border-2 border-gray-300 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-50 transition-colors">
                    End Session
                </button>
            </div>
        </div>
    </div>

    <!-- External Content Database -->
    <script src="content_data.js"></script>

    <script>
        // Database of problems
        // Loaded externally from content_data.js
        if (!window.CONTENT_DATABASE) window.CONTENT_DATABASE = {};

        // ========================================
        // ACCESSIBILITY FEATURES
        // ========================================

        let isScreenReaderActive = false;
        let recognition = null;
        let speechSynthesis = window.speechSynthesis;

        // Screen Reader Announcement Function
        function announceToScreenReader(message) {
            const srDiv = document.getElementById('srAnnouncements');
            if (srDiv) {
                srDiv.textContent = message;

                // Also speak if screen reader is active
                if (isScreenReaderActive && speechSynthesis) {
                    const utterance = new SpeechSynthesisUtterance(message);
                    utterance.rate = 0.9;
                    utterance.pitch = 1;
                    utterance.volume = 1;
                    speechSynthesis.speak(utterance);
                }
            }
        }

        // Initialize Voice Recognition
        function initVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onresult = function (event) {
                    const transcript = event.results[0][0].transcript;
                    const answerInput = document.getElementById('answerInput');
                    const essayInput = document.getElementById('essayInput');

                    if (answerInput && !answerInput.classList.contains('hidden')) {
                        answerInput.value = transcript;
                        announceToScreenReader(`You said: ${transcript}`);
                    } else if (essayInput && !essayInput.classList.contains('hidden')) {
                        essayInput.value += transcript + ' ';
                        announceToScreenReader(`Added to your answer: ${transcript}`);
                    }
                };

                recognition.onerror = function (event) {
                    console.error('Speech recognition error:', event.error);
                    announceToScreenReader('Voice recognition error. Please try again.');
                };

                recognition.onend = function () {
                    const voiceBtn = document.getElementById('voiceBtn');
                    if (voiceBtn) {
                        voiceBtn.classList.remove('bg-red-200', 'animate-pulse');
                        voiceBtn.classList.add('bg-indigo-100');
                    }
                };
            } else {
                console.warn('Speech recognition not supported in this browser');
            }
        }

        // Voice Button Click Handler
        function startVoiceInput() {
            if (!recognition) {
                initVoiceRecognition();
            }

            if (recognition) {
                const voiceBtn = document.getElementById('voiceBtn');
                voiceBtn.classList.remove('bg-indigo-100');
                voiceBtn.classList.add('bg-red-200', 'animate-pulse');

                announceToScreenReader('Listening... Please speak your answer now.');
                recognition.start();
            } else {
                alert('Voice recognition is not supported in your browser. Please use Chrome, Edge, or Safari.');
            }
        }

        // Screen Reader Toggle
        function toggleScreenReader() {
            isScreenReaderActive = !isScreenReaderActive;
            const btn = document.getElementById('screenReaderBtn');

            if (isScreenReaderActive) {
                btn.classList.remove('bg-green-100');
                btn.classList.add('bg-green-500', 'text-white');
                announceToScreenReader('Screen reader activated. Questions and feedback will be read aloud.');

                // Read current question if available
                const questionText = document.getElementById('problemQuestion')?.textContent;
                if (questionText && questionText !== 'Loading question...') {
                    setTimeout(() => {
                        announceToScreenReader(`Current question: ${questionText}`);
                    }, 1000);
                }
            } else {
                btn.classList.remove('bg-green-500', 'text-white');
                btn.classList.add('bg-green-100');
                speechSynthesis.cancel(); // Stop any ongoing speech
                announceToScreenReader('Screen reader deactivated.');
            }
        }

        // Initialize accessibility features on page load
        document.addEventListener('DOMContentLoaded', function () {
            // Voice button
            const voiceBtn = document.getElementById('voiceBtn');
            if (voiceBtn) {
                voiceBtn.addEventListener('click', startVoiceInput);
            }

            // Screen reader button
            const screenReaderBtn = document.getElementById('screenReaderBtn');
            if (screenReaderBtn) {
                screenReaderBtn.addEventListener('click', toggleScreenReader);
            }

            // Initialize voice recognition
            initVoiceRecognition();
        });

        // ========================================
        // END ACCESSIBILITY FEATURES
        // ========================================

        // Learning Session Management
        class LearningSession {
            constructor() {
                this.currentStudent = JSON.parse(localStorage.getItem('currentStudent') || '{}');
                this.sessionStartTime = new Date();
                this.currentProblem = 1;
                this.totalProblems = 10;
                this.problemsSolved = 0;
                this.correctAnswers = 0;
                this.currentStreak = 0;
                this.sessionTimer = null;
                this.questionTimer = null;
                this.problemStartTime = new Date();
                this.questionTimeSeconds = 0;
                this.totalQuestionTime = 0;
                this.questionsAnswered = 0;
                this.hasAttempted = false;

                this.problems = [];

                // Determine subject (prioritize weakestSubject if set, else generic subject)
                let targetSubject = this.currentStudent.subject;
                if (!targetSubject || targetSubject === 'all') {
                    targetSubject = this.currentStudent.weakestSubject || 'mathematics';
                }

                // Load problems based on student class and subject
                const studentClass = this.currentStudent.class; // e.g., "9"
                const classKey = `class_${studentClass}`;
                this.currentSubjectName = targetSubject; // Store for UI usage

                if (window.CONTENT_DATABASE && window.CONTENT_DATABASE[targetSubject] && window.CONTENT_DATABASE[targetSubject][classKey]) {
                    this.problems = window.CONTENT_DATABASE[targetSubject][classKey].problems;
                } else {
                    // Fallback to Class 9 Math if specific combo not found
                    if (window.CONTENT_DATABASE && window.CONTENT_DATABASE['mathematics'] && window.CONTENT_DATABASE['mathematics']['class_9']) {
                        console.log("Fallback to Math Class 9");
                        this.problems = window.CONTENT_DATABASE['mathematics']['class_9'].problems;
                    }
                }

                // If still no problems (database missing), keep a minimal fallback
                if (!this.problems || this.problems.length === 0) {
                    this.problems = [
                        {
                            id: 1,
                            topic: 'General',
                            difficulty: 1,
                            question: `Welcome! We are updating the ${targetSubject} database for Class ${studentClass}. Try this: 2 + 2 = ?`,
                            answer: '4',
                            hint: 'It is the sum of two and two.',
                            solution: ['2 + 2 = 4']
                        }
                    ];
                }

                // Render initial mastery
                this.renderMastery();

                this.init();
            }

            init() {
                this.updateUI();

                // Explicitly reset progress bar UI to start at 0%
                const progressBar = document.getElementById('progressFill');
                if (progressBar) progressBar.style.width = '0%';

                this.loadContent();
                this.setupEventListeners();
            }

            switchMode(mode) {
                this.currentMode = mode;

                const quiz = document.getElementById('quizContainer');
                const notes = document.getElementById('notesContainer');
                const doubt = document.getElementById('doubtContainer');

                // ... rest of switchMode is below this ...
                const sidebar = document.getElementById('sidebarContainer');
                const mainArea = document.getElementById('mainContentArea');

                // Buttons
                const btnQuiz = document.getElementById('btn-mode-quiz');
                const btnNotes = document.getElementById('btn-mode-notes');
                const btnDoubt = document.getElementById('btn-mode-doubt');

                // Reset all
                if (quiz) quiz.classList.add('hidden');
                if (notes) notes.classList.add('hidden');
                if (doubt) doubt.classList.add('hidden');

                [btnQuiz, btnNotes, btnDoubt].forEach(el => {
                    if (el) {
                        el.classList.remove('active', 'border-indigo-500', 'text-indigo-700', 'transform', 'scale-105');
                        el.classList.add('border-gray-200', 'text-gray-500');
                    }
                });

                // Activate selected
                if (mode === 'quiz') {
                    if (quiz) quiz.classList.remove('hidden');
                    if (sidebar) sidebar.classList.remove('hidden');
                    if (mainArea) {
                        mainArea.classList.remove('col-span-4');
                        mainArea.classList.add('lg:col-span-3');
                    }

                    if (btnQuiz) {
                        btnQuiz.classList.add('active', 'border-indigo-500', 'text-indigo-700', 'transform', 'scale-105');
                        btnQuiz.classList.remove('border-gray-200', 'text-gray-500');
                    }
                } else if (mode === 'notes') {
                    if (notes) notes.classList.remove('hidden');
                    if (sidebar) sidebar.classList.add('hidden');
                    if (mainArea) {
                        mainArea.classList.remove('lg:col-span-3');
                        mainArea.classList.add('col-span-4');
                    }

                    if (btnNotes) {
                        btnNotes.classList.add('active', 'border-green-500', 'text-green-700', 'transform', 'scale-105');
                        btnNotes.classList.remove('border-gray-200', 'text-gray-500');
                    }

                    this.showNotes();

                } else if (mode === 'doubt') {
                    if (doubt) doubt.classList.remove('hidden');
                    if (sidebar) sidebar.classList.add('hidden');
                    if (mainArea) {
                        mainArea.classList.remove('lg:col-span-3');
                        mainArea.classList.add('col-span-4');
                    }

                    if (btnDoubt) {
                        btnDoubt.classList.add('active', 'border-orange-500', 'text-orange-700', 'transform', 'scale-105');
                        btnDoubt.classList.remove('border-gray-200', 'text-gray-500');
                    }
                }
            }

            initializeEventListeners() {
                // Enter key to submit answer
                const ansInput = document.getElementById('answerInput');
                if (ansInput) {
                    ansInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.checkAnswer();
                        }
                    });
                }

                // Prevent form submission
                document.addEventListener('submit', (e) => {
                    e.preventDefault();
                });
            }

            loadProblem() {
                const problem = this.problems[this.currentProblem - 1];
                if (!problem) {
                    this.endSession();
                    return;
                }

                // Reset per-problem state
                this.hasAttempted = false;
                this.startQuestionTimer();

                // Update UI
                const topicBadge = document.getElementById('topicBadge');
                if (topicBadge) topicBadge.textContent = problem.topic;

                const problemQuestion = document.getElementById('problemQuestion');
                if (problemQuestion) problemQuestion.textContent = problem.question;

                // If it's AI question (might not have ID in standard list), handle gracefully

                const problemNumber = document.getElementById('problemNumber');
                if (problemNumber) problemNumber.textContent = this.currentProblem;

                const totalProblems = document.getElementById('totalProblems');
                if (totalProblems) totalProblems.textContent = 5; // Fixed limit as per request

                // Reset Inputs
                const answerInput = document.getElementById('answerInput');
                const essayInput = document.getElementById('essayInput');
                const essayFeedback = document.getElementById('essayFeedback');

                if (answerInput) {
                    answerInput.value = '';
                    // Reset styling to default
                    answerInput.className = 'answer-input w-full px-6 py-4 rounded-xl bg-gray-50 focus:outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500 transition-all text-lg';
                }

                if (essayInput) essayInput.value = '';
                if (essayFeedback) essayFeedback.classList.add('hidden');

                if (problem.type === 'subjective') {
                    if (answerInput) answerInput.classList.add('hidden');
                    if (essayInput) essayInput.classList.remove('hidden');
                } else {
                    if (answerInput) answerInput.classList.remove('hidden');
                    if (essayInput) essayInput.classList.add('hidden');
                }

                // Update difficulty indicator
                this.updateDifficultyIndicator(problem.difficulty);

                // Hide panels
                const hintPanel = document.getElementById('hintPanel');
                if (hintPanel) hintPanel.classList.add('hidden');

                const solutionPanel = document.getElementById('solutionPanel');
                if (solutionPanel) solutionPanel.classList.add('hidden');

                const feedbackMessage = document.getElementById('feedbackMessage');
                if (feedbackMessage) feedbackMessage.classList.add('hidden');

                const nextButton = document.getElementById('nextButton');
                if (nextButton) nextButton.classList.add('hidden');

                // Clear AI Options if any (from ai_quiz.js injection)
                const aiOpts = document.getElementById('aiOptions');
                if (aiOpts) aiOpts.classList.add('hidden');

                // Reset problem start time
                this.problemStartTime = new Date();
            }

            updateDifficultyIndicator(difficulty) {
                const dots = document.querySelectorAll('.difficulty-dot');
                dots.forEach((dot, index) => {
                    if (index < difficulty) {
                        dot.classList.add('active');
                    } else {
                        dot.classList.remove('active');
                    }
                });
            }

            checkAnswer() {
                const problem = this.problems[this.currentProblem - 1];

                if (problem.type === 'subjective') {
                    this.gradeEssay(problem);
                    return;
                }

                const userAnswer = document.getElementById('answerInput').value.trim();
                const feedbackMessage = document.getElementById('feedbackMessage');
                const nextButton = document.getElementById('nextButton');

                // Show loading state
                feedbackMessage.textContent = "Analyzing with logical validation...";
                feedbackMessage.className = "feedback-message mt-4 text-blue-600 font-medium block";
                feedbackMessage.classList.remove('hidden');

                // Simulate processing delay often found in AI
                setTimeout(() => {
                    const result = this.validateAnswerLocal(userAnswer, problem);
                    const isCorrect = result.isCorrect;

                    // Display Result
                    if (isCorrect) {
                        this.correctAnswers++;
                        this.currentStreak++;
                        this.showAchievement();

                        // Update XP
                        const xpEl = document.getElementById('xpPoints');
                        if (xpEl) {
                            let currentXP = parseInt(xpEl.textContent) || 0;
                            let gained = 10 + (this.currentStreak * 5); // 10 base + streak bonus
                            xpEl.textContent = currentXP + gained;

                            // Animate XP
                            xpEl.classList.add('scale-150', 'text-green-600');
                            setTimeout(() => xpEl.classList.remove('scale-150', 'text-green-600'), 300);
                        }

                        feedbackMessage.innerHTML = `
                    <div class="flex items-center gap-2 text-green-600">
                        <span class="text-2xl">‚úÖ</span>
                        <div>
                            <div class="font-bold">${result.message}</div>
                            <div class="text-xs text-gray-600 mt-1">${result.explanation}</div>
                        </div>
                    </div>`;

                        this.playSound('correct');
                        if (window.EduAIPlatform) {
                            window.EduAIPlatform.showNotification('Correct Answer! +10 XP', 'success');
                        }
                    } else {
                        this.currentStreak = 0;
                        feedbackMessage.innerHTML = `
                    <div class="flex items-center gap-2 text-red-600">
                        <span class="text-2xl">‚ùå</span>
                        <div>
                            <div class="font-bold">${result.message}</div>
                            <div class="text-xs text-gray-600 mt-1">${result.explanation}</div>
                        </div>
                    </div>`;

                        this.playSound('wrong');
                        if (window.EduAIPlatform) {
                            window.EduAIPlatform.showNotification('Incorrect. ' + result.message, 'error');
                        }
                    }

                    feedbackMessage.classList.remove('hidden');
                    this.hasAttempted = true;
                    this.problemsSolved++;
                    this.updateProgress();

                    if (feedbackMessage.textContent.includes('Incorrect') || feedbackMessage.textContent.includes('‚ùå')) {
                        document.getElementById('solutionPanel').classList.remove('hidden');
                    }
                    nextButton.classList.remove('hidden');
                    clearInterval(this.questionTimer);

                }, 300);
            }

            validateAnswerLocal(userAnswer, problem) {
                // 1. Check Units for Science
                const subject = (this.currentStudent && this.currentStudent.subject) ? this.currentStudent.subject.toLowerCase() : 'science';
                if (subject.includes('science')) {
                    const unitCheck = this.checkScienceUnits(userAnswer, problem.answer);
                    if (!unitCheck.isValid) {
                        return {
                            isCorrect: false,
                            message: unitCheck.message,
                            explanation: "In science, units are crucial. The answer requires the correct physical unit."
                        };
                    }
                }

                // 2. Value Logic
                const isCorrect = userAnswer.toLowerCase() === problem.answer.toLowerCase();

                // 3. Simulated AI Explanation
                let explanation = "";
                if (isCorrect) {
                    explanation = this.generateAIExplanation(true, problem.topic);
                    return {
                        isCorrect: true,
                        message: "Correct Answer!",
                        explanation: explanation
                    };
                } else {
                    // Try numeric tolerance if it's a number
                    const userNum = parseFloat(userAnswer);
                    const ansNum = parseFloat(problem.answer);
                    if (!isNaN(userNum) && !isNaN(ansNum) && userNum === ansNum) {
                        explanation = this.generateAIExplanation(true, problem.topic);
                        return {
                            isCorrect: true,
                            message: "Correct Value!",
                            explanation: explanation
                        };
                    }

                    explanation = `The correct answer was <strong>${problem.answer}</strong>. `;
                    explanation += this.generateAIExplanation(false, problem.topic);
                    return {
                        isCorrect: false,
                        message: "Incorrect Answer",
                        explanation: explanation
                    };
                }
            }

            checkScienceUnits(userAns, expectedAns) {
                // Regex to find Number + Unit string (e.g., "5 kg", "10m/s")
                // Simplified: looks for digits followed by letters
                const expectedUnitMatch = expectedAns.match(/\d+\s*([a-zA-Z%¬∞]+)/);

                if (expectedUnitMatch) {
                    const expectedUnit = expectedUnitMatch[1].toLowerCase();

                    // Check if user answer has digits
                    if (!/\d/.test(userAns)) {
                        return { isValid: false, message: "Your answer is missing the numerical value." };
                    }

                    // Check if user answer has unit
                    const userUnitMatch = userAns.match(/\d+\s*([a-zA-Z%¬∞]+)/);
                    if (!userUnitMatch) {
                        return { isValid: false, message: `Missing units! Expected something like '${expectedUnit}'.` };
                    }

                    const userUnit = userUnitMatch[1].toLowerCase();
                    if (userUnit !== expectedUnit) {
                        return { isValid: false, message: `Incorrect units. Expected '${expectedUnit}', found '${userUnit}'.` };
                    }
                }
                return { isValid: true };
            }

            generateAIExplanation(isCorrect, topic) {
                const correctPhrases = [
                    `This concept is fundamental to understanding ${topic}.`,
                    `Excellent grasp of the core principles of ${topic}.`,
                    `You correctly identified the key relationship here.`,
                    `This calculation aligns perfectly with the formula.`
                ];
                const wrongPhrases = [
                    `It seems like there was a misunderstanding of the ${topic} principles.`,
                    `Review the chapter on ${topic} to clarify this concept.`,
                    `Pay close attention to the details in the question.`,
                    `A common pitfall in ${topic} is overlooking this factor.`
                ];

                const base = isCorrect
                    ? correctPhrases[Math.floor(Math.random() * correctPhrases.length)]
                    : wrongPhrases[Math.floor(Math.random() * wrongPhrases.length)];

                return `${base} (AI Analysis)`;
            }


            showFeedback(isCorrect, userAnswer, correctAnswer, currentProblem) { // Added currentProblem
                const feedbackDiv = document.getElementById('feedbackMessage');
                feedbackDiv.classList.remove('hidden', 'feedback-success', 'feedback-error');

                // The original code had an 'optionDiv' which is not present in this context.
                // Assuming the styling should apply to the answerInput or feedbackDiv itself.
                // For now, I'll omit 'optionDiv' styling as it's not defined.

                if (isCorrect) {
                    // Correct Answer
                    // optionDiv.classList.add('bg-green-100', 'border-green-500', 'text-green-700'); // Removed as optionDiv is not defined

                    // Determine message based on new difficulty state (simulated)
                    let diffMsg = "Good job! Keeping steady.";
                    // Assuming 'this.student' and 'this.student.mastery' exist for adaptive logic
                    const currentScore = this.student && this.student.mastery && currentProblem.topic ? this.student.mastery[currentProblem.topic.toLowerCase()] || 50 : 50;
                    if (currentScore > 70) diffMsg = "Excellent! Moving to harder questions next. üöÄ";

                    feedbackDiv.innerHTML = `<div class="flex items-center text-green-700 font-bold mb-2">
                       <span class="text-2xl mr-2">‚úì</span> Correct! ${diffMsg}
                   </div>${currentProblem.solution ? `<div class="text-gray-600 text-sm bg-white p-3 rounded-lg border border-green-200 mt-2">${currentProblem.solution}</div>` : ''}`;

                    // Assuming this.playSuccessSound() exists
                    if (this.playSuccessSound) this.playSuccessSound();
                    // this.problemsSolved++; // This is already handled in checkAnswer, avoid double counting

                    // Update Mastery - Assuming this.updateMastery() exists
                    if (this.updateMastery && currentProblem.topic) this.updateMastery(true, currentProblem.topic);

                } else {
                    // Incorrect Answer
                    // optionDiv.classList.add('bg-red-100', 'border-red-500', 'text-red-700'); // Removed as optionDiv is not defined

                    // Determine remediation message
                    const hintMsg = currentProblem.hint || "Review the concept notes to strengthen this topic.";

                    feedbackDiv.innerHTML = `<div class="flex flex-col space-y-2">
                       <div class="flex items-center text-red-700 font-bold">
                            <span class="text-2xl mr-2">‚úó</span> Not quite right.
                       </div>
                       <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 text-sm text-yellow-800 rounded-r">
                            <strong>üí° Adaptive Hint:</strong> ${hintMsg}
                       </div>
                       ${currentProblem.solution ? `<div class="text-gray-600 text-sm bg-white p-3 rounded-lg border border-red-200"><strong>Full Solution:</strong> ${currentProblem.solution}</div>` : ''}
                   </div>`;

                    // Assuming this.playErrorSound() exists
                    if (this.playErrorSound) this.playErrorSound();

                    // Update Mastery - Assuming this.updateMastery() exists
                    if (this.updateMastery && currentProblem.topic) this.updateMastery(false, currentProblem.topic);
                }
                // Animate feedback
                anime({
                    targets: feedbackDiv,
                    scale: [0.8, 1],
                    opacity: [0, 1],
                    duration: 300,
                    easing: 'easeOutCubic'
                });
            }

            showHint() {
                const problem = this.problems[this.currentProblem - 1];
                const hintPanel = document.getElementById('hintPanel');
                document.getElementById('hintText').textContent = problem.hint;

                hintPanel.classList.remove('hidden');

                // Animate hint panel
                anime({
                    targets: hintPanel,
                    translateY: [-20, 0],
                    opacity: [0, 1],
                    duration: 300,
                    easing: 'easeOutCubic'
                });
            }

            showNotes() {
                const problem = this.problems[this.currentProblem - 1];
                const noteText = document.getElementById('noteText');

                if (!noteText) return;

                const studentClass = this.currentStudent.class;
                const classKey = `class_${studentClass}`;
                const subject = this.currentSubjectName || 'mathematics';
                // Fallback to problem topic, or currently selected topic from setup
                const topic = problem ? problem.topic : (document.getElementById('topicBadge') ? document.getElementById('topicBadge').textContent : "General");

                let noteContent = "No specific notes available for this topic.";

                if (window.CONTENT_DATABASE &&
                    window.CONTENT_DATABASE[subject] &&
                    window.CONTENT_DATABASE[subject][classKey] &&
                    window.CONTENT_DATABASE[subject][classKey].notes &&
                    window.CONTENT_DATABASE[subject][classKey].notes[topic]) {

                    noteContent = window.CONTENT_DATABASE[subject][classKey].notes[topic];
                }

                noteText.textContent = noteContent;

                // No animation needed here as tab switch handles it
            }

            showSolution() {
                if (!this.hasAttempted) {
                    if (!confirm("‚ö†Ô∏è Warning: You haven't attempted this question yet!\n\nIt's best to try solving it yourself first. Are you sure you want to see the solution?")) {
                        return;
                    }
                }

                const problem = this.problems[this.currentProblem - 1];
                const solutionPanel = document.getElementById('solutionPanel');
                const solutionSteps = document.getElementById('solutionSteps');

                solutionSteps.innerHTML = problem.solution.map((step, index) => `
                    <div class="flex items-center space-x-3">
                        <span class="w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-bold">
                            ${index + 1}
                        </span>
                        <span>${step}</span>
                    </div>
                `).join('');

                solutionPanel.classList.remove('hidden');

                // Animate solution panel
                anime({
                    targets: solutionPanel,
                    translateY: [-20, 0],
                    opacity: [0, 1],
                    duration: 300,
                    easing: 'easeOutCubic'
                });

                // Log solution view
                this.logPerformance({
                    action: 'solution_viewed',
                    problemId: problem.id
                });
            }

            nextProblem() {
                if (this.currentProblem < this.totalProblems) {
                    this.currentProblem++;
                    this.loadProblem();
                } else {
                    this.endSession();
                }
            }

            skipProblem() {
                this.logPerformance({
                    action: 'problem_skipped',
                    problemId: this.problems[this.currentProblem - 1].id
                });
                this.nextProblem();
            }

            updateProgress() {
                const progressPercent = Math.round((this.currentProblem / this.totalProblems) * 100);
                const accuracy = this.problemsSolved > 0 ? Math.round((this.correctAnswers / this.problemsSolved) * 100) : 0;

                // Update progress ring
                const circle = document.getElementById('progressCircle');
                const circumference = 2 * Math.PI * 40;
                const offset = circumference - (progressPercent / 100) * circumference;
                circle.style.strokeDashoffset = offset;

                // Update text
                document.getElementById('progressPercent').textContent = `${progressPercent}%`;
                document.getElementById('problemsSolved').textContent = this.problemsSolved;
                document.getElementById('accuracyPercent').textContent = `${accuracy}%`;
                document.getElementById('streakCount').textContent = this.currentStreak;

                // Update topic mastery (simplified)
                this.updateTopicMastery();
            }

            updateTopicMastery() {
                // Get topics for the current class and subject
                let topics = ['Topic 1', 'Topic 2', 'Topic 3']; // Fallback

                const studentClass = this.currentStudent.class;
                const classKey = `class_${studentClass}`;
                const subject = this.currentSubjectName || 'mathematics';

                if (window.CONTENT_DATABASE && window.CONTENT_DATABASE[subject] && window.CONTENT_DATABASE[subject][classKey]) {
                    // Take first 5 topics
                    topics = window.CONTENT_DATABASE[subject][classKey].topics.slice(0, 5);
                }

                const topicMasteryDiv = document.getElementById('topicMastery');

                // Add subject header
                let html = `<h4 class="text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider">${subject.replace('_', ' ')} MASTERY</h4>`;

                html += topics.map(topic => `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-gray-600 truncate mr-2" style="max-width: 120px;">${topic}</span>
                        <div class="w-16 bg-gray-200 rounded-full h-2 flex-shrink-0">
                            <div class="bg-gradient-to-r from-sage-green to-green-500 h-2 rounded-full" 
                                 style="width: ${Math.floor(Math.random() * 40) + 60}%"></div>
                        </div>
                    </div>
                `).join('');

                topicMasteryDiv.innerHTML = html;
            }

            showAchievement() {
                if (this.currentStreak === 3 || this.currentStreak === 5 || this.currentStreak === 10) {
                    const popup = document.getElementById('achievementPopup');
                    document.getElementById('achievementText').textContent =
                        `You've solved ${this.currentStreak} problems in a row! Keep it up!`;

                    popup.classList.add('show');
                    this.createConfetti();

                    setTimeout(() => {
                        this.closeAchievement();
                    }, 3000);
                }
            }

            closeAchievement() {
                document.getElementById('achievementPopup').classList.remove('show');
            }

            createConfetti() {
                const colors = ['#f59e0b', '#10b981', '#3b82f6', '#ef4444', '#8b5cf6'];

                for (let i = 0; i < 50; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 3 + 's';
                    document.body.appendChild(confetti);

                    setTimeout(() => {
                        confetti.remove();
                    }, 3000);
                }
            }

            startTimer() {
                let seconds = 0;
                this.sessionTimer = setInterval(() => {
                    seconds++;
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = seconds % 60;
                    document.getElementById('sessionTimer').textContent =
                        `Total: ${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
                }, 1000);
            }

            startQuestionTimer() {
                clearInterval(this.questionTimer);
                this.questionTimeSeconds = 0;
                document.getElementById('currentQuestionTimer').textContent = 'Curr: 0s';

                this.questionTimer = setInterval(() => {
                    this.questionTimeSeconds++;
                    document.getElementById('currentQuestionTimer').textContent = `Curr: ${this.questionTimeSeconds}s`;
                }, 1000);
            }

            updateAverageTime() {
                if (this.questionsAnswered > 0) {
                    const avg = Math.round(this.totalQuestionTime / this.questionsAnswered);
                    document.getElementById('avgTimer').textContent = `Avg: ${avg}s`;
                }
            }

            pauseSession() {
                clearInterval(this.sessionTimer);
                document.getElementById('pauseModal').classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            resumeSession() {
                this.startTimer();
                document.getElementById('pauseModal').classList.add('hidden');
                document.body.style.overflow = 'auto';
            }

            endSession() {
                clearInterval(this.sessionTimer);

                // Save session data
                const sessionData = {
                    student: this.currentStudent,
                    startTime: this.sessionStartTime,
                    endTime: new Date(),
                    problemsSolved: this.problemsSolved,
                    correctAnswers: this.correctAnswers,
                    accuracy: this.problemsSolved > 0 ? (this.correctAnswers / this.problemsSolved) * 100 : 0,
                    currentStreak: this.currentStreak
                };

                localStorage.setItem('lastSession', JSON.stringify(sessionData));

                // Redirect to dashboard
                window.location.href = 'dashboard.html';
            }

            logPerformance(data) {
                const performanceLog = JSON.parse(localStorage.getItem('performanceLog') || '[]');
                performanceLog.push({
                    ...data,
                    timestamp: new Date().toISOString(),
                    student: this.currentStudent
                });
                localStorage.setItem('performanceLog', JSON.stringify(performanceLog));
            }
            gradeEssay(problem) {
                const userEssay = document.getElementById('essayInput').value.trim();
                const feedbackPanel = document.getElementById('essayFeedback');
                const keywords = problem.keywords || [];

                if (userEssay.length < 20) {
                    feedbackPanel.innerHTML = `<span class="text-red-600 font-bold">Too short!</span> Please write at least one complete sentence.`;
                    feedbackPanel.classList.remove('hidden', 'bg-green-50', 'border-green-200', 'bg-yellow-50', 'border-yellow-200');
                    feedbackPanel.classList.add('bg-red-50', 'border-red-200');
                    feedbackPanel.classList.remove('hidden');
                    return;
                }

                let matches = 0;
                const matchedKeywords = [];
                const lowerEssay = userEssay.toLowerCase();

                keywords.forEach(kw => {
                    if (lowerEssay.includes(kw.toLowerCase())) {
                        matches++;
                        matchedKeywords.push(kw);
                    }
                });

                const score = Math.round((matches / keywords.length) * 100);
                let review = "";
                let colorClass = "";

                if (score >= 80) {
                    review = "üåü Excellent! You covered most key points.";
                    colorClass = "text-green-700 bg-green-50 border-green-200";
                } else if (score >= 50) {
                    review = "üëç Good effort. Try to include more specific terms.";
                    colorClass = "text-yellow-700 bg-yellow-50 border-yellow-200";
                } else {
                    review = "ü§î You might be missing some key concepts.";
                    colorClass = "text-red-700 bg-red-50 border-red-200";
                }

                const feedbackHTML = `
                    <div class="${colorClass} p-3 rounded-lg mb-2">
                        <strong>AI Grade: ${score}/100</strong> - ${review}
                    </div>
                    <div class="text-gray-600">
                        <p class="mb-1"><strong>Keywords found:</strong> ${matchedKeywords.length > 0 ? matchedKeywords.join(', ') : 'None'}</p>
                        <p><strong>Rubric:</strong> ${problem.rubric || 'N/A'}</p>
                    </div>
                `;

                feedbackPanel.innerHTML = feedbackHTML;
                feedbackPanel.classList.remove('hidden');

                // Mark as solved if score is decent
                if (score >= 50) {
                    this.correctAnswers++; // Treat as correct for stats
                    this.currentStreak++;
                    this.showAchievement();
                } else {
                    this.currentStreak = 0;
                }

                this.problemsSolved++;
                this.hasAttempted = true;
                this.updateProgress();

                // Stop timer
                clearInterval(this.questionTimer);
            }
        }

        // Global functions
        function switchMode(mode) {
            learningSession.switchMode(mode);
        }

        function checkAnswer() {
            learningSession.checkAnswer();
        }

        function showHint() {
            learningSession.showHint();
        }

        function showSolution() {
            learningSession.showSolution();
        }

        function showNotes() {
            // Updated to switch mode instead of just calling method if we want full tab switch
            // But for now, let's keep it as is or redirect to switchMode('notes')?
            // User might click "Concept Note" button which calls showNotes()
            // If that button is still there (in Sidebar), we might want it to switch mode.
            // Only Sidebar has "Concept Note" button now.
            learningSession.switchMode('notes');
        }

        function nextProblem() {
            learningSession.nextProblem();
        }

        function skipProblem() {
            learningSession.skipProblem();
        }

        function pauseSession() {
            learningSession.pauseSession();
        }

        function resumeSession() {
            learningSession.resumeSession();
        }

        function endSession() {
            if (confirm('Are you sure you want to end this session? Your progress will be saved.')) {
                learningSession.endSession();
            }
        }

        function closeAchievement() {
            learningSession.closeAchievement();
        }

        function toggleDarkMode() {
            const html = document.documentElement;
            const isDark = html.classList.toggle('dark');
            const icon = document.getElementById('darkModeIcon');

            icon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('darkMode', isDark);

            // Toggle generic bg classes if they aren't fully tailwind 'dark:' compatible
            if (isDark) {
                document.body.classList.remove('bg-gray-50');
                document.body.classList.add('bg-gray-900', 'text-white');
            } else {
                document.body.classList.add('bg-gray-50');
                document.body.classList.remove('bg-gray-900', 'text-white');
            }

            // Update cards background
            const cards = document.querySelectorAll('.bg-white, .problem-card');
            cards.forEach(card => {
                if (isDark) {
                    card.classList.remove('bg-white');
                    card.classList.add('bg-gray-800', 'text-white');
                    card.classList.add('bg-white');
                    card.classList.remove('bg-gray-800', 'text-white');
                }
            });
        }

        // Initialize learning session
        // Make it globally accessible for Onboarding Modal
        window.learningSession = null;

        document.addEventListener('DOMContentLoaded', () => {
            // Add some subjective questions for testing
            if (window.CONTENT_DATABASE && window.CONTENT_DATABASE.science && window.CONTENT_DATABASE.science.class_9) {
                window.CONTENT_DATABASE.science.class_9.problems.push({
                    id: "s9_essay_1",
                    topic: "Matter in Our Surroundings",
                    type: "subjective",
                    difficulty: 4,
                    question: "Explain why evaporation causes cooling in about 30-50 words.",
                    keywords: ["energy", "absorb", "surroundings", "particles", "liquid", "gas", "latent heat"],
                    rubric: "Mention absorption of energy from surroundings and change of state.",
                    solution: ["Particles of liquid absorb energy from the surroundings to regain the energy lost during evaporation. This absorption of energy makes the surroundings cold."],
                    hint: "Think about where the particles get energy to escape."
                });
            }

            window.learningSession = new LearningSession();

            if (localStorage.getItem('darkMode') === 'true') {
                toggleDarkMode(); // Reuse function to set initial state
                document.getElementById('darkModeIcon').textContent = '‚òÄÔ∏è';
            }

            // Load Language Summaries and merge
            fetch('language_summaries.json')
                .then(response => response.json())
                .then(data => {
                    if (!window.CONTENT_DATABASE) window.CONTENT_DATABASE = {};

                    data.forEach(subjectData => {
                        const subjectName = subjectData.subject.toLowerCase(); // 'english' or 'hindi'
                        if (!window.CONTENT_DATABASE[subjectName]) window.CONTENT_DATABASE[subjectName] = {};

                        subjectData.classes.forEach(cls => {
                            const classKey = `class_${cls.class}`;
                            if (!window.CONTENT_DATABASE[subjectName][classKey]) {
                                window.CONTENT_DATABASE[subjectName][classKey] = { topics: [], notes: {}, problems: [] };
                            }

                            // Merge Summaries into Notes
                            cls.chapters.forEach(chapter => {
                                const topicName = chapter.title;
                                if (!window.CONTENT_DATABASE[subjectName][classKey].topics.includes(topicName)) {
                                    window.CONTENT_DATABASE[subjectName][classKey].topics.push(topicName);
                                }
                                if (!window.CONTENT_DATABASE[subjectName][classKey].notes) window.CONTENT_DATABASE[subjectName][classKey].notes = {};
                                window.CONTENT_DATABASE[subjectName][classKey].notes[topicName] = chapter.summary;
                            });
                        });
                    });
                    console.log('Language Summaries Loaded');

                    // Trigger the Session Setup Modal now that data is loaded
                    initSessionSetup();
                })
                .catch(err => {
                    console.error('Error loading summaries:', err);
                    // Even on error, we should try to init setup with what we have
                    initSessionSetup();
                });
        });

        // Session Setup Logic
        function initSessionSetup() {
            // 1. Fetch Parameters from URL (Deep Linking support)
            const urlParams = new URLSearchParams(window.location.search);
            const urlSubject = urlParams.get('subject');
            const urlClass = urlParams.get('class');
            const urlTopic = urlParams.get('topic');
            const urlAction = urlParams.get('action');

            let student = JSON.parse(localStorage.getItem('currentStudent'));

            // Override with URL params if present
            if (urlSubject) {
                if (!student) student = { name: "Guest", class: "9", subject: urlSubject }; // Fallback
                student.subject = urlSubject;
                if (urlClass) student.class = urlClass;
                localStorage.setItem('currentStudent', JSON.stringify(student));
            }

            if (!student) return;

            const subject = student.subject || 'mathematics';
            const studentClass = student.class || '9';
            const classKey = `class_${studentClass}`;

            // Populate Topics for Onboarding
            let topics = [];
            if (window.CONTENT_DATABASE[subject] && window.CONTENT_DATABASE[subject][classKey]) {
                topics = window.CONTENT_DATABASE[subject][classKey].topics || [];
            }

            // Use the global helper if available, or direct DOM
            if (window.populateOnboardingTopics) {
                window.populateOnboardingTopics(topics);
            } else {
                const selector = document.getElementById('topicSelectorOnboarding');
                if (selector) {
                    selector.innerHTML = '<option value="">Choose a topic...</option>';
                    topics.forEach(t => {
                        const opt = document.createElement('option');
                        opt.value = t;
                        opt.textContent = t;
                        selector.appendChild(opt);
                    });
                }
            }

            // Auto-Select Topic from URL
            if (urlTopic) {
                const selector = document.getElementById('topicSelectorOnboarding');
                if (selector) {
                    for (let i = 0; i < selector.options.length; i++) {
                        if (selector.options[i].value.toLowerCase() === urlTopic.toLowerCase()) {
                            selector.selectedIndex = i;
                            break;
                        }
                    }
                    if (window.checkTopicReady) window.checkTopicReady();
                }
            }

            // Auto-Start Action from URL if topic is selected/valid
            if (urlAction && urlTopic) {
                // Close onboarding and start
                const modal = document.getElementById('onboardingModal');
                if (modal) modal.classList.add('hidden');
                switchMode(urlAction === 'quiz' ? 'quiz' : urlAction);
                return;
            }

            // Show Onboarding Modal
            const modal = document.getElementById('onboardingModal');
            if (modal) modal.classList.remove('hidden');
        }

        function startSessionAction(action) {
            const topic = document.getElementById('topicSelector').value;
            const modal = document.getElementById('sessionSetupModal');

            // Apply Topic Filter if selected
            if (topic) {
                // Filter problems in the active session
                // We need to access the private/internal problems list of learningSession
                // Since this is a demo, we'll just re-init or filter.

                // Better approach: use the internal filter logic if it existed, or just simplistic filtering:
                const allProblems = learningSession.problems; // Assuming we can access or reload them
                const filtered = allProblems.filter(p => p.topic === topic);

                if (filtered.length > 0) {
                    learningSession.problems = filtered.slice(0, 5); // Enforce 5 question limit
                    learningSession.totalProblems = learningSession.problems.length;
                    learningSession.currentProblem = 1;
                    learningSession.loadProblem();
                } else {
                    // If no questions for this topic (e.g. only notes exist), we might need to rely on AI generation
                    // But if action is 'notes', we don't need questions.
                    if (action !== 'notes' && confirm(`No pre-set questions found for "${topic}". Generate one with Edu AI?`)) {
                        modal.classList.add('hidden');
                        // Update badge manually so AI knows context
                        document.getElementById('topicBadge').textContent = topic;
                        window.generateAIQuestion();
                        return;
                    }
                }

                // Update badge
                const badge = document.getElementById('topicBadge');
                if (badge) badge.textContent = topic;
            }

            modal.classList.add('hidden');

            // Handle Actions
            if (action === 'notes') {
                switchMode('notes');
            } else if (action === 'doubt') {
                switchMode('doubt');
            } else {
                switchMode('quiz');
            }
        }
    </script>
    <script>
        // API Client for Edu AI (Backend: main.py)

        window.generateAIQuestion = function () {
            const topic = document.getElementById('topicBadge').textContent || "General";
            const feedbackMsg = document.getElementById('feedbackMessage');

            if (window.learningSession && window.learningSession.problemsSolved >= 5) {
                alert("Quiz Complete! You have finished 5 questions.");
                window.learningSession.endSession();
                return;
            }

            feedbackMsg.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            feedbackMsg.classList.add('bg-blue-100', 'text-blue-700');
            feedbackMsg.textContent = "ü§ñ GyanNova is crafting a unique question...";
            feedbackMsg.classList.remove('hidden');

            // Simulate A delay
            setTimeout(() => {
                const mockData = {
                    question: `(AI Generated) What is a key characteristic of ${topic}?`,
                    options: [
                        `It is essential for ${topic} principles.`,
                        `It contradicts ${topic}.`,
                        `It is unrelated to ${topic}.`,
                        `None of the above.`
                    ],
                    answer: `It is essential for ${topic} principles.`,
                    explanation: `This option correctly aligns with the fundamental definitions of ${topic} explored in Class 9 curriculum.`
                };

                feedbackMsg.textContent = `ü§ñ Generated question for ${topic}!`;
                loadAIProblem(mockData);
                setTimeout(() => feedbackMsg.classList.add('hidden'), 1500);
            }, 300);
        };

        function loadAIProblem(data) {
            const problemCard = document.getElementById('problemQuestion');
            problemCard.textContent = data.question;

            const ansInput = document.getElementById('answerInput');
            const essayInput = document.getElementById('essayInput');

            if (ansInput) ansInput.classList.add('hidden');
            if (essayInput) essayInput.classList.add('hidden');

            let optionsDiv = document.getElementById('aiOptions');
            if (!optionsDiv) {
                optionsDiv = document.createElement('div');
                optionsDiv.id = 'aiOptions';
                optionsDiv.className = 'grid grid-cols-1 gap-3 mb-6';
                if (ansInput && ansInput.parentNode) {
                    ansInput.parentNode.insertBefore(optionsDiv, ansInput);
                }
            }
            optionsDiv.innerHTML = '';
            optionsDiv.classList.remove('hidden');

            document.getElementById('nextButton').classList.add('hidden');

            data.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-4 rounded-xl border-2 border-gray-200 hover:border-blue-500 hover:bg-blue-50 transition-all font-medium text-gray-700";
                btn.textContent = opt;
                btn.onclick = () => checkAIAnswer(opt, data.answer, data.explanation, btn);
                optionsDiv.appendChild(btn);
            });
        }

        function checkAIAnswer(selected, correct, explanation, btnElement) {
            const isCorrect = selected === correct;

            // Access global session
            if (window.learningSession) {
                if (isCorrect) {
                    window.learningSession.correctAnswers++;
                    window.learningSession.currentStreak++;
                    window.learningSession.showAchievement();
                    window.learningSession.playSound('correct');
                } else {
                    window.learningSession.currentStreak = 0;
                    window.learningSession.playSound('wrong');
                }
                window.learningSession.problemsSolved++;
                window.learningSession.updateProgress();
            }

            // Disable all buttons
            const allBtns = document.getElementById('aiOptions').querySelectorAll('button');
            allBtns.forEach(b => b.disabled = true);

            if (isCorrect) {
                btnElement.classList.remove('border-gray-200', 'hover:border-blue-500', 'hover:bg-blue-50');
                btnElement.classList.add('bg-green-100', 'border-green-500', 'text-green-800');
                document.getElementById('feedbackMessage').innerHTML = `<span class="text-green-600 font-bold">Correct!</span> ${explanation}`;
            } else {
                btnElement.classList.remove('border-gray-200', 'hover:border-blue-500', 'hover:bg-blue-50');
                btnElement.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
                document.getElementById('feedbackMessage').innerHTML = `<span class="text-red-600 font-bold">Incorrect.</span> The correct answer is: ${correct}. ${explanation}`;
            }
            document.getElementById('feedbackMessage').classList.remove('hidden');

            // Show Next Button logic
            const nextBtn = document.getElementById('nextButton');
            nextBtn.classList.remove('hidden');

            // Override Next Button OnClick to call generateAIQuestion again if we are in AI mode
            nextBtn.onclick = function () {
                window.generateAIQuestion();
                // Reset UI for next question
                document.getElementById('feedbackMessage').classList.add('hidden');
                nextBtn.classList.add('hidden');
            };
        }
    </script>

    <!-- Tour Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Check if tour has been seen
            if (!localStorage.getItem('tourSeen')) {
                startTour();
            }
        });

        function startTour() {
            const tourSteps = [
                {
                    element: '#subjectTitle',
                    title: 'Welcome to GyanNova!',
                    text: 'This is your personalized learning dashboard. We have tailored this path just for you.'
                },
                {
                    element: '.mode-switcher',
                    title: 'Choose Your Mode',
                    text: 'Switch between taking Quizzes, reading Concept Notes, or asking the GyanNova AI Tutor a doubt.'
                },
                {
                    element: '#quiz-section',
                    title: 'Quiz Zone',
                    text: 'Practice problems here. The AI adapts the difficulty based on your answers!'
                },
                {
                    element: '#ai-tutor-web',
                    title: 'Ask GyanNova',
                    text: 'Stuck? Switch to "Ask GyanNova" to get instant help on any topic.'
                }
            ];

            let header = document.createElement('div');
            header.id = 'tour-overlay';
            header.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:9999;backdrop-filter:blur(3px);display:flex;justify-content:center;align-items:center;transition:all 0.3s;';

            let card = document.createElement('div');
            card.className = 'bg-white p-8 rounded-2xl max-w-md text-center shadow-2xl transform transition-all scale-100 border-4 border-sage-green/20';
            card.innerHTML = `
                <div class="text-5xl mb-4 animate-bounce">üëã</div>
                <h3 class="text-2xl font-bold mb-3 text-sage-green">Welcome to GyanNova!</h3>
                <p class="text-gray-600 mb-8 leading-relaxed">Let's take a quick interactive tour of your new AI-powered learning environment.</p>
                <div class="flex gap-4 justify-center">
                    <button onclick="endTour()" class="px-6 py-2 rounded-full font-semibold text-gray-500 hover:bg-gray-100 transition">Skip</button>
                    <button onclick="nextTourStep()" class="bg-sage-green text-white px-8 py-2 rounded-full font-bold hover:bg-green-700 transition shadow-lg hover:shadow-xl transform hover:-translate-y-1">Start Tour üöÄ</button>
                </div>
            `;

            header.appendChild(card);
            document.body.appendChild(header);

            window.currentTourStep = -1;
            window.tourSteps = tourSteps;
            window.lastHighlightedElement = null; // Track highlighted element
        }

        window.endTour = function () {
            const overlay = document.getElementById('tour-overlay');
            if (overlay) overlay.remove();

            // Cleanup highlight
            if (window.lastHighlightedElement) {
                window.lastHighlightedElement.style.boxShadow = '';
                window.lastHighlightedElement.style.zIndex = '';
                window.lastHighlightedElement.style.position = '';
                window.lastHighlightedElement.style.background = '';
            }

            localStorage.setItem('tourSeen', 'true');
        }

        window.nextTourStep = function () {
            // Cleanup previous highlight
            if (window.lastHighlightedElement) {
                window.lastHighlightedElement.style.boxShadow = '';
                window.lastHighlightedElement.style.zIndex = '';
                window.lastHighlightedElement.style.position = '';
                window.lastHighlightedElement.style.background = '';
            }

            window.currentTourStep++;
            const overlay = document.getElementById('tour-overlay');
            const step = window.tourSteps[window.currentTourStep];

            if (!step) {
                endTour();
                return;
            }

            // Update card content
            const card = overlay.querySelector('div.bg-white');
            const isLast = window.currentTourStep === window.tourSteps.length - 1;

            card.innerHTML = `
                <div class="text-left relative">
                    <span class="absolute -top-4 -right-4 text-xs font-bold bg-gray-100 text-gray-500 px-2 py-1 rounded-full">Step ${window.currentTourStep + 1}/${window.tourSteps.length}</span>
                    <h3 class="text-xl font-bold mb-3 text-sage-green flex items-center gap-2">
                        <span>‚ú®</span> ${step.title}
                    </h3>
                    <p class="text-gray-600 mb-6 leading-relaxed">${step.text}</p>
                    <div class="flex justify-between items-center mt-4 border-t pt-4 border-gray-100">
                        <button onclick="endTour()" class="text-xs font-semibold text-gray-400 hover:text-gray-600 transition">Skip Tour</button>
                        <button onclick="nextTourStep()" class="bg-sage-green text-white px-6 py-2 rounded-lg text-sm font-bold hover:bg-green-700 transition shadow-md flex items-center gap-2">
                            ${isLast ? 'Finish' : 'Next'} 
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                </div>
            `;

            // Highlight element logic
            const target = document.querySelector(step.element);
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Add highlight
                target.style.transition = 'all 0.3s';
                target.style.position = 'relative'; // Ensure z-index works
                target.style.zIndex = '10000'; // Bring above overlay masking if needed, or just high enough
                target.style.boxShadow = '0 0 0 4px #2D5A3D, 0 0 50px rgba(45,90,61,0.4)';
                target.style.background = 'white'; // Default bg for legibility if needed
                target.style.borderRadius = '12px'; // Soften edges

                window.lastHighlightedElement = target;
            }
        };
    </script>
</body>

</html>